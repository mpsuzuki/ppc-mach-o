VERS_STRING_PATH_LOCAL := `pwd`/vers_string
VERS_STRING_PATH ?= $(VERS_STRING_PATH_LOCAL)
VERS_STRING_GIT ?= @GIT@
LLVM_CONFIG ?= @LLVM_CONFIG@
.PHONY: _ld64 _cctools

all:
	make _ld64
	make _cctools

clean:
	rm -rf prunetrie
	make -C ppc-ld64 clean
	make -C cctools clean

_ld64:
	make -C ppc-ld64 CCTOOLS=../cctools LLDB=../ppc-libunwind
	make -C ppc-ld64 install-prune-trie PREFIX=../prunetrie

CCTOOLS_PROJECT := $(shell $(VERS_STRING_GIT) -C cctools remote | head -1 | xargs $(VERS_STRING_GIT) -C cctools remote get-url | xargs -I{} basename {} .git)
CCTOOLS_VERSION := $(shell $(VERS_STRING_GIT) -C cctools describe --tags | sed "s/^$(CCTOOLS_PROJECT)-*//;s/-/./g")

_cctools:
	env \
	PATH=${PATH}:$(VERS_STRING_PATH) \
	VERS_STRING_GIT=$(VERS_STRING_GIT) \
	RC_ProjectSourceVersion=$(CCTOOLS_VERSION) \
	make -C cctools \
	TRIE="-DTRIE_SUPPORT -I"`pwd`"/prunetrie/include/ppc-ld64/" \
	LIB_PRUNETRIE=`pwd`/prunetrie/libexec/ppc-ld64/libprunetrie.a \
	LTO="-DLTO_SUPPORT -I"`$(LLVM_CONFIG) --includedir`
	env \
	PATH=${PATH}:$(VERS_STRING_PATH) \
	VERS_STRING_GIT=$(VERS_STRING_GIT) \
	RC_ProjectSourceVersion=$(CCTOOLS_VERSION) \
	make -C cctools/libmacho \
	TRIE="-DTRIE_SUPPORT -I"`pwd`"/prunetrie/include/ppc-ld64/" \
	LIB_PRUNETRIE=`pwd`/prunetrie/libexec/ppc-ld64/libprunetrie.a \
	LTO="-DLTO_SUPPORT -I"`$(LLVM_CONFIG) --includedir`

install-cctools:
	mkdir -p root/bin
	mkdir -p root/include/mach-o
	mkdir -p root/lib
	mkdir -p root/libexec/gcc/darwin
	mkdir -p root/libexec/gcc/darwin/arm
	mkdir -p root/libexec/gcc/darwin/hppa
	mkdir -p root/libexec/gcc/darwin/i386
	mkdir -p root/libexec/gcc/darwin/i860
	mkdir -p root/libexec/gcc/darwin/m68k
	mkdir -p root/libexec/gcc/darwin/m88k
	mkdir -p root/libexec/gcc/darwin/ppc
	mkdir -p root/libexec/gcc/darwin/ppc64
	mkdir -p root/libexec/gcc/darwin/sparc
	mkdir -p root/libexec/gcc/darwin/x86_64

	install -c -m 755 cctools/as/driver_dir/driver root/bin/as
	install -c -m 755 cctools/as/a386_dir/as root/libexec/gcc/darwin/i386/as
	install -c -m 755 cctools/as/a860_dir/as root/libexec/gcc/darwin/i860/as
	install -c -m 755 cctools/as/a68_dir/as root/libexec/gcc/darwin/m68k/as
	install -c -m 755 cctools/as/a88_dir/as root/libexec/gcc/darwin/m88k/as
	install -c -m 755 cctools/as/aarm_dir/as root/libexec/gcc/darwin/arm/as
	install -c -m 755 cctools/as/ahppa_dir/as root/libexec/gcc/darwin/hppa/as
	install -c -m 755 cctools/as/appc64_dir/as root/libexec/gcc/darwin/ppc64/as
	install -c -m 755 cctools/as/appc_dir/as root/libexec/gcc/darwin/ppc/as
	install -c -m 755 cctools/as/asparc_dir/as root/libexec/gcc/darwin/sparc/as
	install -c -m 755 cctools/as/ax86_64_dir/as root/libexec/gcc/darwin/x86_64/as
	install -c -m 755 cctools/gprof/gprof.NEW root/bin/gprof
	for misc_bin in \
		checksyms seg_addr_table check_dylib indr seg_hack \
		strip strings size nm libtool lipo segedit cmpdylib \
		pagestuff redo_prebinding nmedit install_name_tool \
		codesign_allocate ctf_insert ; \
	do \
		install -c -m 755 cctools/misc/$${misc_bin}.NEW root/bin/$${misc_bin} ; \
	done
	install -c -m 755 cctools/otool/otool.NEW root/bin/otool
	install -c -m 755 cctools/ar/ar.NEW root/bin/ar
	install -c -m 755 cctools/efitools/mtoc.NEW root/bin/mtoc

	install -c -m 644 cctools/misc/libredo_prebinding.a root/lib/libredo_prebinding.a
	install -c -m 644 cctools/cbtlibs/libsyminfo.a root/lib/libsyminfo.a
	install -c -m 644 cctools/libmacho/otmp_obj/libmacho_static.a root/lib/libmacho_static.a
	install -c -m 644 cctools/libmacho/dtmp_obj/libmacho.a root/lib/libmacho_debug.a
	install -c -m 644 cctools/libmacho/dtmp_obj/libmacho.dylib root/lib/libmacho.dylib
	install -c -m 644 cctools/libmacho/ptmp_obj/libmacho_pg.a root/lib/libmacho_profile.a

#	env \
#	PATH=${PATH}:$(VERS_STRING_PATH) \
#	VERS_STRING_GIT=$(VERS_STRING_GIT) \
#	RC_ProjectSourceVersion=$(CCTOOLS_VERSION) \
#	make -C cctools install DSTROOT=`pwd`/root \
#	TRIE="-DTRIE_SUPPORT -I"`pwd`"/prunetrie/include/ppc-ld64/" \
#	LIB_PRUNETRIE=`pwd`/prunetrie/libexec/ppc-ld64/libprunetrie.a \
#	LTO="-DLTO_SUPPORT -I"`$(LLVM_CONFIG) --includedir`
